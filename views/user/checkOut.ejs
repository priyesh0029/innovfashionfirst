<script src="/assets/js/formUserValidation.js"></script>




<body>


    <main class="main">
        <div class="page-header breadcrumb-wrap">
            <div class="container">
                <div class="breadcrumb">
                    <a href="/">Home</a>
                    <span></span> Shop
                    <span></span> Checkout
                </div>
            </div>
        </div>
        <section class="mt-50 mb-50">
            <div class="container">


                <div class="row">
                    <div id="checkOutForm" class="d-md-flex">
                        <div class="col-md-6 me-3">
                            <div class="order_review">
                                <div class="mb-20">
                                    <h4>Delivery Address</h4>
                                </div>
                                <div class="table-responsive order_table text-center">

                                    <table class="table">
                                        <% if(addressCount!==null){%>
                                            <tbody>
                                                <% for(let i=0;i < addressCount;i++){%>
                                                    <tr>
                                                        <td class="mb-5 d-flex">
                                                            <div><input type="radio" name="addressId"
                                                                    value="<%=userAddress.address[i]._id%>"
                                                                    id="<%=userAddress.address[i]._id%>" checked>
                                                            </div>
                                                            <ul class="text-start mt-15 ms-2 ">
                                                                <label for="<%=userAddress.address[i]._id%>">
                                                                    <li>
                                                                        <h5>
                                                                            <%=userAddress.address[i].name%>,
                                                                                <%=userAddress.address[i].phonenumber%>
                                                                        </h5>
                                                                    </li>
                                                                    <li>
                                                                        <h5>
                                                                            <%=userAddress.address[i].addressLine%>,
                                                                                <%=userAddress.address[i].locality%>,
                                                                                    <%=userAddress.address[i].city%>,
                                                                                        near(
                                                                                        <%=userAddress.address[i].landmark%>
                                                                                            ),
                                                                                            <%=userAddress.address[i].state%>
                                                                                                -
                                                                                                <%=userAddress.address[i].pincode%>

                                                                        </h5>
                                                                    </li>
                                                                </label>
                                                            </ul>
                                                        </td>
                                                    </tr>

                                                    <%} %>
                                            </tbody>
                                            <%}else {%>
                                                <tr>
                                                    <h5 class="text-secondary text-start">Add any address to proceed
                                                        your
                                                        Checkout</h5>
                                                </tr>
                                                <%} %> %>
                                    </table>
                                    <!-- <a href="/"><button class="btn btn-primary">Add New Address</button></a> -->

                                    <!-- modal-start -->



                                    <div class="text-center">

                                        <button type="button" class="btn btn-small btn-rounded mb-4" data-toggle="modal"
                                            data-target="#modalContactForm">Add New Address</button>
                                        <span id="radioAddressError"></span>
                                    </div>

                                    <!-- modal-end -->

                                </div>
                                <div class="bt-1 border-color-1 mt-30 mb-30"></div>

                            </div>

                        </div>

                        <div class="col-md-6">
                            <div class="order_review">
                                <div class="mb-20">
                                    <h4>Your Orders</h4>
                                </div>
                                <div class="table-responsive order_table text-center">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th colspan="2">Product</th>
                                                <th>Total</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <% for(let i=0;i < count;i++){%>
                                                <tr>
                                                    <td class="image product-thumbnail"><img
                                                            src="/uploads/<%= cart.product[i].product_id.Image[0]%>"
                                                            alt="#">
                                                    </td>
                                                    <td>
                                                        <h5><a href="shop-product-full.html">
                                                                <%=cart.product[i].product_id.product_name %>
                                                            </a></h5>
                                                        <span class="product-qty">x <%=cart.product[i].quantity %>
                                                        </span>
                                                    </td>
                                                    <td>₹<%=cart.product[i].sub_total %>
                                                    </td>
                                                </tr>
                                                <%} %>
                                                    <tr>
                                                        <th>SubTotal</th>
                                                        <td class="product-subtotal" colspan="2">₹ <%= grand_Total %>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <th>Shipping</th>
                                                        <td colspan="2"><em>Free Shipping</em></td>
                                                    </tr>
                                                    <tr>
                                                        <th>Total</th>
                                                        <td colspan="2" class="product-subtotal"><span
                                                                class="font-xl text-brand fw-900">₹ <%= grand_Total %>
                                                            </span></td>
                                                    </tr>

                                        </tbody>
                                    </table>
                                </div>
                                <div class="bt-1 border-color-1 mt-30 mb-30"></div>
                                <div class="payment_method">
                                    <div class="mb-25">
                                        <h5>Payment</h5>
                                        <h4 id="walletAmountId" style="font-family: 'Lato';"></h4>
                                    </div>
                                    <div class="payment_option">
                                        <div class="custome-radio">
                                            <input class="form-check-input" required="" type="radio"
                                                name="payment_option" id="exampleRadios3" value="COD" checked
                                                onclick="paymentRadio()">
                                            <label class="form-check-label" for="exampleRadios3"
                                                data-bs-toggle="collapse" data-target="#bankTranfer"
                                                aria-controls="bankTranfer">COD(cash on delivery)</label>
                                            <div class="form-group collapse in" id="bankTranfer">
                                                <p class="text-muted mt-5">There are many variations of passages of
                                                    Lorem
                                                    Ipsum available, but the majority have suffered alteration. </p>
                                            </div>
                                        </div>
                                        <div class="custome-radio">
                                            <input class="form-check-input" required="" type="radio"
                                                name="payment_option" id="exampleRadios4" value="Razorpay"
                                                onclick="paymentRadio()">
                                            <label class="form-check-label" for="exampleRadios4"
                                                data-bs-toggle="collapse" data-target="#checkPayment"
                                                aria-controls="checkPayment">Razorpay</label>
                                            <div class="form-group collapse in" id="checkPayment">
                                                <p class="text-muted mt-5">Please send your cheque to Store Name, Store
                                                    Street, Store Town, Store State / County, Store Postcode. </p>
                                            </div>
                                        </div>
                                        <div class="custome-radio">
                                            <input class="form-check-input" required="" type="radio"
                                                name="payment_option" id="exampleRadios5" value="Wallet"
                                                onclick="walletInfo('<%=walletAmount%>','<%= grand_Total %>')">
                                            <label class="form-check-label" for="exampleRadios5"
                                                data-bs-toggle="collapse" data-target="#paypal"
                                                aria-controls="paypal">Wallet</label>
                                            <div class="form-group collapse in" id="paypal">
                                                <p class="text-muted mt-5">Pay via PayPal; you can pay with your credit
                                                    card
                                                    if you don't have a PayPal account.</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- <a href="/placeOrder?userId=<%=cart.userId%>&grand_"
                                class="btn btn-fill-out btn-block mt-30">Place Order</a> -->
                                <button class="btn btn-fill-out btn-block mt-30"
                                    onclick="placeOrder('<%= grand_Total %>')" id="rzp-button1">Place
                                    Order</button>
                            </div>
                            <span>
                                <h4 class="text-danger" id="placeOrderErrors"></h4>
                            </span>
                        </div>
                    </div>
                </div>
            </div>

        </section>
    </main>


    <!-- modal-form-start -->
    <div class="modal fade" id="modalContactForm" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title w-100 font-weight-bold">Your New Address</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <form action="/postAddress?pageInfo=checkout" method="post" id="form">
                    <div class="modal-body mx-3">
                        <div class="form-row d-flex justify-content-center">
                            <div class="md-form mb-5 me-2 text-start col-md-6">
                                <input type="text" id="formName" class="form-control validate" placeholder="Name"
                                    name="fname" onkeyup="validateName()" required>
                                <span class="" id="name-error"></span>
                            </div>

                            <div class="md-form mb-5 text-start col-md-6">
                                <input type="tel" id="formMobile" class="form-control validate"
                                    placeholder="10-digit phonenumber" name="phonenumber" onkeyup="validateMobile()"
                                    required>
                                <span class="text-danger" id="mobile-error"></span>
                            </div>
                        </div>
                        <div class="form-row d-flex justify-content-center">
                            <div class="md-form mb-5 me-2 text-start col-md-6">
                                <input type="text" id="formPincode" class="form-control validate" placeholder="pincode"
                                    name="pincode" onkeyup="validatePincode()">
                                <span class="text-danger" id="pincode-error"></span>
                            </div>

                            <div class="md-form mb-5 text-start col-md-6">
                                <input type="text" id="formLocality" class="form-control validate"
                                    placeholder="locality" name="locality" onkeyup="validateLocality()">
                                <span class="text-danger" id="locality-error"></span>
                            </div>
                        </div>
                        <div class="md-form mb-5 text-start">
                            <input type="text" id="formAddress" class="form-control validate"
                                placeholder="address(area and street)" name="address" onkeyup="validateAddress()">
                            <span class="text-danger" id="address-error"></span>

                        </div>
                        <div class="form-row d-flex justify-content-center">
                            <div class="md-form mb-5 text-start col-md-6">
                                <input type="text" id="formCity" class="form-control validate"
                                    placeholder="city/district/town" name="city" onkeyup="validateCity()">
                                <span class="text-danger" id="city-error"></span>

                            </div>

                            <div class="md-form mb-5 text-start col-md-6">
                                <input type="text" id="formState" class="form-control validate" placeholder="state"
                                    name="state" onkeyup="validateState()">
                                <span class="text-danger" id="state-error"></span>

                            </div>
                        </div>
                        <div class="form-row d-flex justify-content-center">
                            <div class="md-form mb-5 text-start col-md-6">

                                <input type="text" id="form29" class="form-control validate"
                                    placeholder="Landmark(optional)" name="landmark">

                            </div>

                            <div class="md-form mb-5 text-start col-md-6">

                                <input type="tel" id="formAltmobile" class="form-control validate"
                                    placeholder="Alternate Phone(optional)" name="phoneAlt"
                                    onkeyup="validateAltMobile()">
                                <span class="text-danger" id="altmobile-error"></span>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer d-flex justify-content-center">
                        <button type="submit" id="submit" class="btn btn-unique"
                            onclick="validateForm()">Save</button><br>
                        <span class="text-danger" id="submit-error"></span>
                    </div>
                </form>
                <span class="text-success" id="success"></span>
            </div>
        </div>
    </div>

</body>
<script>
    function placeOrder(grandTotal = null) {
        const radioGroup = document.getElementsByName("payment_option");
        let payment_option;
        for (let i = 0; i < radioGroup.length; i++) {
            if (radioGroup[i].checked) {
                payment_option = radioGroup[i].value;
                break;
            }
        }
        const radioGroup2 = document.getElementsByName("addressId");
        let addressId;
        for (let i = 0; i < radioGroup2.length; i++) {
            if (radioGroup2[i].checked) {
                addressId = radioGroup2[i].value;
                break;
            }
        }
        console.log("addressId newly added : ", addressId);
        if (addressId === undefined) {
            document.getElementById("placeOrderErrors").innerHTML = "Add any address to continue..!"
        } else {
            document.getElementById("placeOrderErrors").innerHTML = ""
            console.log(payment_option, addressId);

            $.ajax({
                url: "/placeOrder",
                type: "post",
                data: {
                    addressId,
                    payment_option
                },
                success: (response) => {
                    console.log(response);
                    if (response.userCart === false) {
                        location.href = "/"
                    }
                    if (response.CodStatus) {
                        location.href = `/orderLandingPage?orderId=${response.orderId}`
                    } else if (response.Razorstatus) {
                        getRazorpay(response)
                    } else if (response.WalletStatus) {
                        location.href = `/orderLandingPage?orderId=${response.orderId}`
                    }
                },
                error: (response) => {
                    console.log(response);
                    location.href = "/"
                }
            })
        }


    }

    const getRazorpay = (order) => {
        var options = {
            "key": "rzp_test_wdO1BDjnHakmYI", // Enter the Key ID generated from the Dashboard
            "amount": order.amount, // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
            "currency": "INR",
            "name": "Acme Corp", //your business name
            "description": "Test Transaction",
            "order_id": order.id, //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
            "handler": function (response) {
                verifyPayment(order, response);
            },
            "prefill": {
                "name": "Gaurav Kumar", //your customer's name
                "email": "gaurav.kumar@example.com",
                "contact": "9000090000"
            },
            "notes": {
                "address": "Razorpay Corporate Office"
            },
            "theme": {
                "color": "#3399cc"
            }
        };
        var rzp1 = new Razorpay(options);
        rzp1.on('payment.failed', function (response) {
            // alert(response.error.code);
            // alert(response.error.description);
            // alert(response.error.source);
            // alert(response.error.step);
            // alert(response.error.reason);
            // alert(response.error.metadata.order_id);
            // alert(response.error.metadata.payment_id);
        });
        // document.getElementById('rzp-button1').onclick = function (e) {
        //     e.preventDefault();
        //     rzp1.open();
        // }
        rzp1.open();


    }

    const verifyPayment = (payment, order) => {
        console.log("paymentand order 55555555555555555555555555555: ", payment, order);
        $.ajax({
            type: "post",
            url: '/verify-payment',
            data: {
                payment,
                order
            },
            success: (response) => {
                if (response.status) {
                    console.log(response)
                    location.href = `/orderLandingPage?orderId=${payment.receipt}`

                } else {
                    // $('#failureModal').modal('show');
                    // setTimeout(() => {
                    //     location.href = '/proceed-to-checkout'
                    // }, 3000)
                    alert("payment failed")
                }
            }
        })
    }

    function walletInfo(walletAmount, grandTotal) {
        if (parseInt(grandTotal) > walletAmount) {
            let error = document.getElementById("walletAmountId")
            error.innerHTML = "your total wallet amount is ₹" + walletAmount + ".00. Unable to checkout..!"
            error.style.color = "red";
            let myButton = document.getElementById("rzp-button1");
            myButton.disabled = true;
        } else if (walletAmount === null) {
            let error = document.getElementById("walletAmountId")
            error.innerHTML = "your  wallet amount is ₹0.00. Unable to checkout..!"
            error.style.color = "red";
            let myButton = document.getElementById("rzp-button1");
            myButton.disabled = true;
        } else {
            let text = document.getElementById("walletAmountId")
            text.innerHTML = "your total wallet amount is ₹" + walletAmount + ".00"
            text.style.color = "green";
        }
    }

    function paymentRadio() {
        document.getElementById("walletAmountId").innerHTML = ""
        let myButton = document.getElementById("rzp-button1");
        myButton.disabled = false;
    }
</script>